# 💳 支付功能使用说明

## ✅ 已完成的功能

1. ✅ 添加了 Stripe 支付集成
2. ✅ 创建了支付页面 (`payment.html`)
3. ✅ 修改了结果页面，显示支付按钮
4. ✅ 支付成功后自动创建账号并登录
5. ✅ 用户可以看到完整报告

## 🚀 设置步骤

### 第一步：创建 Stripe 账号

1. 访问 https://stripe.com
2. 注册账号（免费）
3. 验证邮箱

### 第二步：获取 Stripe API Keys

1. 登录 https://dashboard.stripe.com
2. 确保在 **"Test mode"**（测试模式）
3. 点击左侧 "Developers" → "API keys"
4. 复制两个 Key：
   - **Publishable key** (pk_test_...)
   - **Secret key** (sk_test_...) - 点击 "Reveal test key" 查看

### 第三步：在 Render 中设置环境变量

1. 登录 Render，进入你的 Web Service
2. 点击 "Environment" 标签
3. 添加两个环境变量：

   **第一个：**
   - Key: `STRIPE_SECRET_KEY`
   - Value: `sk_test_...`（你的 Secret Key）

   **第二个：**
   - Key: `STRIPE_PUBLISHABLE_KEY`
   - Value: `pk_test_...`（你的 Publishable Key）

4. 点击 "Save Changes"
5. Render 会自动重新部署

### 第四步：推送代码

```bash
cd "/Users/kiukiu/Five Elements Test"
git add .
git commit -m "Add Stripe payment integration"
git push
```

## 🧪 测试支付

### 使用测试卡号

在 Stripe 测试模式下，使用以下测试卡号：

- **卡号**: `4242 4242 4242 4242`
- **过期日期**: 任何未来日期（如 `12/25`）
- **CVC**: 任何 3 位数字（如 `123`）
- **邮编**: 任何 5 位数字（如 `12345`）

### 测试流程

1. 访问你的网站
2. 提交分析请求
3. 在结果页面点击 "💳 Unlock Full Report - $2.99"
4. 跳转到支付页面
5. 使用测试卡号支付
6. 支付成功后：
   - 自动创建账号
   - 自动登录
   - 显示账号信息（用户名和密码）
   - 自动跳转到结果页面
   - 可以看到完整报告

## 💰 支付流程

1. **用户点击支付按钮**
   - 跳转到 `payment.html`
   - 显示价格和功能列表

2. **用户点击 "Pay $2.99 to Unlock"**
   - 调用 `/api/create-checkout-session`
   - 创建 Stripe Checkout Session
   - 跳转到 Stripe 支付页面

3. **用户完成支付**
   - 在 Stripe 页面输入卡号
   - 支付成功

4. **支付成功回调**
   - Stripe 重定向到 `/payment-success`
   - 验证支付状态
   - 自动生成用户名和密码
   - 保存到 USERS 数据库
   - 自动登录
   - 重定向到结果页面，显示完整报告

## 📝 账号管理

### 自动生成的账号格式

- **用户名**: `user_xxxxxxxx`（8位随机字符）
- **密码**: `xxxxxxxxxxxx`（12位随机字符）

### 账号保存

- 账号保存在 `USERS` 字典中
- 支付成功后立即可用
- 用户可以保存账号信息，以后可以登录

### 显示账号信息

支付成功后，会弹出提示框显示：
```
Payment successful! Your account has been created:

Username: user_abc12345
Password: xYz789AbC123

Please save these credentials.
```

## ⚠️ 重要提示

### 测试模式 vs 生产模式

**测试模式（开发时）：**
- 使用 `sk_test_...` 和 `pk_test_...`
- 不会产生真实费用
- 使用测试卡号

**生产模式（上线时）：**
1. 在 Stripe Dashboard 关闭 "Test mode"
2. 获取 Live keys（`sk_live_...` 和 `pk_live_...`）
3. 更新 Render 环境变量
4. 重新部署

### 安全

- ✅ Secret Key 只存储在环境变量中
- ✅ 不会提交到 GitHub
- ✅ 使用 Stripe 的安全支付页面
- ✅ 不处理信用卡信息

### 账号持久化

当前账号保存在内存中（`USERS` 字典），如果服务器重启会丢失。

**如果需要持久化：**
- 可以保存到文件
- 或使用数据库（SQLite, PostgreSQL 等）

## 🎯 用户体验流程

1. 用户提交分析 → 立即看到八字信息
2. 看到 "Unlock Full Report - $2.99" 按钮
3. 点击按钮 → 跳转到支付页面
4. 点击支付 → 跳转到 Stripe 支付页面
5. 完成支付 → 自动创建账号并登录
6. 自动跳转回结果页面 → 看到完整报告

## ✅ 检查清单

- [ ] 创建了 Stripe 账号
- [ ] 获取了测试环境的 API Keys
- [ ] 在 Render 中设置了环境变量
- [ ] 推送了代码
- [ ] Render 重新部署成功
- [ ] 测试支付流程
- [ ] 支付成功后能自动登录
- [ ] 能看到完整报告

## 🎉 完成！

设置完成后，用户就可以通过支付 $2.99 来解锁完整报告了！

